import React, { useState } from 'react';

// --- Helper Components ---

// Placeholder component before an image is generated
const Placeholder = () => (
    <div className="w-full h-full bg-gray-200 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
    </div>
);

// Loading spinner component
const Spinner = () => (
    <div className="w-full h-full bg-gray-200 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
    </div>
);

// Error message component
const ErrorDisplay = ({ onRetry }) => (
     <div className="w-full h-full bg-red-100 text-red-700 flex flex-col items-center justify-center p-4">
        <p className="text-sm text-center">Failed to generate image. Please try again.</p>
        <button onClick={onRetry} className="mt-2 px-3 py-1 bg-red-600 text-white text-xs font-semibold rounded-md hover:bg-red-700 transition-colors">
            Retry
        </button>
    </div>
);

// --- Main App Component ---

export default function App() {
    // Initial state for all the Small Garden Landscape ideas
    const [recipes, setRecipes] = useState([
        { title: "Use Vertical Gardening to Save Space", prompt: "A real-life photo of a small balcony with a rustic wooden pallet repurposed as a vertical garden, filled with lush herbs and trailing strawberries. The shot looks like a clever, space-saving solution from a genuine urban gardener's Instagram.", imageUrl: null, loading: false, error: false },
        { title: "Choose a Cohesive Color Palette", prompt: "A beautiful, real garden bed in a small space, planted with a cohesive palette of blue and purple flowers like salvia and lavender. The effect is calming and visually expansive. Looks like an authentic photo from a gardening social media feed.", imageUrl: null, loading: false, error: false },
        { title: "Define Zones with Edging or Pavers", prompt: "A small backyard with a winding gravel path that cleverly separates a tiny lawn area from a flower bed. The curved lines make the space feel larger and more dynamic. The shot is a real-life example of smart small-garden design.", imageUrl: null, loading: false, error: false },
        { title: "Add a Statement Plant or Water Feature", prompt: "A stylish, large terracotta pot with a single, beautiful dwarf olive tree, acting as a focal point on a small, chic patio. The photo has a modern, minimalist feel, like a feature from a design blog.", imageUrl: null, loading: false, error: false },
        { title: "Choose Multi-Functional Furniture", prompt: "A real-life shot of a small patio with a smart, built-in wooden bench that has a hinged top, showing storage space for cushions inside. The photo looks practical and highlights a genuine space-saving solution.", imageUrl: null, loading: false, error: false },
        { title: "Use Lighting to Extend Usability", prompt: "An enchanting evening photo of a small garden, with warm, glowing solar-powered fairy lights strung along a fence. The soft lighting makes the tiny space feel incredibly cozy and magical. Looks like a candid moment captured on a phone.", imageUrl: null, loading: false, error: false },
        { title: "Donâ€™t Forget Vertical Herbs and Edibles", prompt: "A real-life photo of a window box planter mounted on a railing, overflowing with fresh basil, mint, and a few small cherry tomato plants. The shot is a close-up, showcasing a productive and attractive edible garden in a tiny space.", imageUrl: null, loading: false, error: false },
        { title: "Keep It Clutter-Free", prompt: "A photo of a very neat and tidy small balcony garden. Tools are hung neatly on the wall, and the plants are well-pruned. The space feels calm, organized, and larger because it's so uncluttered. The style is clean and minimalist, like a post from a home organization social media account.", imageUrl: null, loading: false, error: false }
    ]);
    
    // State to track if all images are being generated
    const [isGeneratingAll, setIsGeneratingAll] = useState(false);

    // Function to handle image generation for a single item
    const handleGenerateImage = async (index) => {
        // Prevent generation if already loading
        if (recipes[index].loading) return;

        setRecipes(currentRecipes =>
            currentRecipes.map((recipe, i) =>
                i === index ? { ...recipe, loading: true, error: false } : recipe
            )
        );

        const recipeToGenerate = recipes[index];
        const payload = {
          instances: [{ prompt: recipeToGenerate.prompt }],
          parameters: { "sampleCount": 1 }
        };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();

            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                setRecipes(currentRecipes =>
                    currentRecipes.map((recipe, i) =>
                        i === index ? { ...recipe, imageUrl: imageUrl, loading: false } : recipe
                    )
                );
            } else {
                 throw new Error("Invalid response structure from API.");
            }
        } catch (error) {
            console.error("Error generating image:", error);
            setRecipes(currentRecipes =>
                currentRecipes.map((recipe, i) =>
                    i === index ? { ...recipe, loading: false, error: true } : recipe
                )
            );
        }
    };

    // Function to generate all missing images with a staggered start
    const handleGenerateAllImages = async () => {
        setIsGeneratingAll(true);
        // Loop through all recipes
        for (let i = 0; i < recipes.length; i++) {
            const recipe = recipes[i];
            // Only generate if the image doesn't exist and it's not already loading
            if (!recipe.imageUrl && !recipe.loading) {
                // Trigger the generation for the current item
                handleGenerateImage(i);
                // Wait 2 seconds before proceeding to the next item
                await new Promise(resolve => setTimeout(resolve, 2000));
            }
        }
        // Re-enable the button after all generations have been triggered
        setIsGeneratingAll(false);
    };
    
    return (
        <div className="bg-gray-50 min-h-screen font-sans">
            <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                <header className="text-center mb-8">
                    <h1 className="text-4xl sm:text-5xl font-bold text-gray-800 tracking-tight">Small Garden Landscape Idea Gallery</h1>
                    <p className="mt-3 text-lg text-gray-600 max-w-2xl mx-auto">Maximize your green space in style. Click to generate an image for any idea.</p>
                    <div className="mt-6">
                        <button
                            onClick={handleGenerateAllImages}
                            disabled={isGeneratingAll}
                            className="px-6 py-3 text-base font-semibold text-white bg-indigo-600 rounded-lg shadow-md transition-all hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        >
                            {isGeneratingAll ? 'Generating All...' : 'Generate All Images'}
                        </button>
                    </div>
                </header>

                <main className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    {recipes.map((recipe, index) => (
                        <div key={index} className="bg-white rounded-lg shadow-md overflow-hidden flex flex-col transition-transform transform hover:scale-105">
                           
                            <div className="aspect-square w-full relative">
                                {recipe.loading ? <Spinner /> : 
                                 recipe.error ? <ErrorDisplay onRetry={() => handleGenerateImage(index)} /> :
                                 recipe.imageUrl ? (
                                    <>
                                        <img src={recipe.imageUrl} alt={recipe.title} className="w-full h-full object-cover" />
                                        {/* Regenerate Button */}
                                        <button
                                            onClick={() => handleGenerateImage(index)}
                                            className="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 focus:outline-none focus:ring-2 focus:ring-white transition-all"
                                            aria-label="Regenerate image"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8m18 4a9 9 0 0 1-15 6.7L21 16"/></svg>
                                        </button>
                                    </>
                                 ) : 
                                 <Placeholder />}
                            </div>
                            
                            <div className="p-4 flex flex-col flex-grow">
                                <h2 className="text-lg font-semibold text-gray-800 flex-grow">{recipe.title}</h2>
                                <button
                                    onClick={() => handleGenerateImage(index)}
                                    disabled={recipe.loading || isGeneratingAll}
                                    className="mt-4 w-full px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md shadow-sm transition-all
                                    hover:bg-indigo-700 
                                    focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500
                                    disabled:bg-gray-400 disabled:cursor-default disabled:transform-none"
                                >
                                    {recipe.loading ? 'Generating...' : recipe.imageUrl ? 'Regenerate' : 'Generate Image'}
                                </button>
                            </div>
                        </div>
                    ))}
                </main>
            </div>
        </div>
    );
}
