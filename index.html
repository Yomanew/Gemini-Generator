import React, { useState } from 'react';

// --- Helper Components ---

// Placeholder component before an image is generated
const Placeholder = () => (
    <div className="w-full h-full bg-gray-200 flex items-center justify-center">
        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1" strokeLinecap="round" strokeLinejoin="round" className="text-gray-400">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
    </div>
);

// Loading spinner component
const Spinner = () => (
    <div className="w-full h-full bg-gray-200 flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
    </div>
);

// Error message component
const ErrorDisplay = ({ onRetry }) => (
     <div className="w-full h-full bg-red-100 text-red-700 flex flex-col items-center justify-center p-4">
        <p className="text-sm text-center">Failed to generate image. Please try again.</p>
        <button onClick={onRetry} className="mt-2 px-3 py-1 bg-red-600 text-white text-xs font-semibold rounded-md hover:bg-red-700 transition-colors">
            Retry
        </button>
    </div>
);

// --- Main App Component ---

export default function App() {
    // Initial state for all the recipes with their titles and image generation prompts
    const [recipes, setRecipes] = useState([
        { title: "Choose the Right Spot", prompt: "A candid photo of a sunny backyard with a person thoughtfully pointing to the perfect, sun-drenched spot for a new vegetable garden. The image has warm, natural lighting, conveying a sense of planning and potential. Looks like a real moment captured for a gardening blog.", imageUrl: null, loading: false, error: false },
        { title: "Know Your Growing Zone", prompt: "A close-up, top-down shot of a person's hands holding a smartphone displaying a USDA Hardiness Zone map. On the rustic wooden table are several seed packets. The feel is authentic and practical, like a real gardener planning their season. Instagram-style.", imageUrl: null, loading: false, error: false },
        { title: "Pick Your Layout Style", prompt: "A visually appealing, collage-style image showing four distinct garden layouts. A neat traditional row garden, a beautiful wooden raised bed, a gridded square foot garden, and some vibrant container pots on a patio. The photo looks like an informative social media post.", imageUrl: null, loading: false, error: false },
        { title: "Sketch It Out First", prompt: "A flat lay of a hand-drawn garden plan on graph paper. A pencil, an eraser, and a few seed packets are scattered around the paper on a wooden table. It looks like a genuine, creative planning session captured from above.", imageUrl: null, loading: false, error: false },
        { title: "Use Companion Planting", prompt: "A close-up shot from inside a thriving garden bed, showing lush tomato plants growing happily next to bushy basil plants. The lighting is bright and natural, highlighting the healthy leaves. This looks like a real-life example from a gardener's social media feed.", imageUrl: null, loading: false, error: false },
        { title: "Mind the Spacing", prompt: "A real-world photo looking down a row of young lettuce plants that are perfectly spaced, with rich, dark soil visible between them. The image clearly illustrates the concept of giving plants room to grow, as if taken by a proud gardener on their phone.", imageUrl: null, loading: false, error: false },
        { title: "Group by Watering Needs", prompt: "A practical shot of a garden bed where one side has thirsty leafy greens like lettuce and spinach, looking moist, while the other side has more drought-tolerant herbs like rosemary and thyme. A watering can is placed near the thirsty plants. Looks like a smart, real-life garden setup.", imageUrl: null, loading: false, error: false },
        { title: "Plan for Crop Rotation", prompt: "An image of a rustic, open garden journal on a potting bench. The page shows a hand-drawn diagram and notes about crop rotation for the upcoming seasons. Feels authentic, personal, and educational, like a tip shared in a gardening group.", imageUrl: null, loading: false, error: false },
        { title: "Add Paths for Easy Access", prompt: "A beautiful, real-life garden with inviting wood chip paths between several raised beds filled with thriving vegetables. A person is comfortably kneeling on the path, tending to the plants. The image feels accessible and well-designed, captured on a sunny day.", imageUrl: null, loading: false, error: false },
        { title: "Leave Room to Grow", prompt: "A wide shot of a well-maintained vegetable garden with an empty, prepared plot of land adjacent to it, suggesting future expansion. In the background, a compost bin is visible. The scene looks hopeful and full of potential, like a real backyard project in progress.", imageUrl: null, loading: false, error: false }
    ]);

    // Function to handle image generation and regeneration
    const handleGenerateImage = async (index) => {
        setRecipes(currentRecipes =>
            currentRecipes.map((recipe, i) =>
                i === index ? { ...recipe, loading: true, error: false } : recipe
            )
        );

        const recipeToGenerate = recipes[index];
        const payload = {
          instances: [{ prompt: recipeToGenerate.prompt }],
          parameters: { "sampleCount": 1 }
        };
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();

            if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                const imageUrl = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                setRecipes(currentRecipes =>
                    currentRecipes.map((recipe, i) =>
                        i === index ? { ...recipe, imageUrl: imageUrl, loading: false } : recipe
                    )
                );
            } else {
                 throw new Error("Invalid response structure from API.");
            }
        } catch (error) {
            console.error("Error generating image:", error);
            setRecipes(currentRecipes =>
                currentRecipes.map((recipe, i) =>
                    i === index ? { ...recipe, loading: false, error: true } : recipe
                )
            );
        }
    };
    
    return (
        <div className="bg-gray-50 min-h-screen font-sans">
            <div className="container mx-auto p-4 sm:p-6 lg:p-8">
                <header className="text-center mb-8">
                    <h1 className="text-4xl sm:text-5xl font-bold text-gray-800 tracking-tight">Gardening Layout Idea Gallery</h1>
                    <p className="mt-3 text-lg text-gray-600 max-w-2xl mx-auto">Plan like a pro and grow like a boss. Click to generate a unique image for any gardening tip.</p>
                </header>

                <main className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
                    {recipes.map((recipe, index) => (
                        <div key={index} className="bg-white rounded-lg shadow-md overflow-hidden flex flex-col transition-transform transform hover:scale-105">
                           
                            <div className="aspect-square w-full relative">
                                {recipe.loading ? <Spinner /> : 
                                 recipe.error ? <ErrorDisplay onRetry={() => handleGenerateImage(index)} /> :
                                 recipe.imageUrl ? (
                                    <>
                                        <img src={recipe.imageUrl} alt={recipe.title} className="w-full h-full object-cover" />
                                        {/* Regenerate Button */}
                                        <button
                                            onClick={() => handleGenerateImage(index)}
                                            className="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-75 focus:outline-none focus:ring-2 focus:ring-white transition-all"
                                            aria-label="Regenerate image"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 2v6h6"/><path d="M21 12A9 9 0 0 0 6 5.3L3 8m18 4a9 9 0 0 1-15 6.7L21 16"/></svg>
                                        </button>
                                    </>
                                 ) : 
                                 <Placeholder />}
                            </div>
                            
                            <div className="p-4 flex flex-col flex-grow">
                                <h2 className="text-lg font-semibold text-gray-800 flex-grow">{recipe.title}</h2>
                                <button
                                    onClick={() => handleGenerateImage(index)}
                                    disabled={recipe.loading || !!recipe.imageUrl}
                                    className="mt-4 w-full px-4 py-2 text-sm font-semibold text-white bg-indigo-600 rounded-md shadow-sm transition-all
                                    hover:bg-indigo-700 
                                    focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500
                                    disabled:bg-green-500 disabled:cursor-default disabled:transform-none"
                                >
                                    {recipe.loading ? 'Generating...' : recipe.imageUrl ? 'Generated!' : 'Generate Image'}
                                </button>
                            </div>
                        </div>
                    ))}
                </main>
            </div>
        </div>
    );
}
